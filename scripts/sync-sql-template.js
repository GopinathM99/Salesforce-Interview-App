#!/usr/bin/env node

/**
 * This script reads the SQL template from supabase/insert_questions_template.sql
 * and generates lib/followUpPromptTemplate.ts automatically.
 *
 * Run this script whenever you update the SQL template:
 *   node scripts/sync-sql-template.js
 *
 * Or it will run automatically before dev/build via package.json scripts.
 */

const fs = require('fs');
const path = require('path');

const SQL_SOURCE = path.join(__dirname, '..', 'supabase', 'insert_questions_template.sql');
const TS_OUTPUT = path.join(__dirname, '..', 'lib', 'followUpPromptTemplate.ts');

try {
  // Read the SQL file
  let sqlContent = fs.readFileSync(SQL_SOURCE, 'utf-8');

  // Remove the comment header from SQL file (lines starting with --)
  const lines = sqlContent.split('\n');
  const sqlWithoutComments = lines
    .filter(line => !line.trim().startsWith('--') || line.trim() === '')
    .join('\n')
    .trim();

  // Generate the TypeScript file content
  const tsContent = `// ⚠️ AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
// This file is automatically generated from supabase/insert_questions_template.sql
// To update: edit the SQL file, then run: npm run sync-sql-template
// Last generated: ${new Date().toISOString()}

// SQL template for Gemini follow-up prompt
export const SQL_TEMPLATE = \`${sqlWithoutComments}\`;

export interface PromptOptions {
  topics?: string[];
  categories?: string[];
  difficulties?: string[];
  questionTypes?: string[];
}

export const getFollowUpPrompt = (options?: PromptOptions) => {
  const { topics, categories, difficulties, questionTypes } = options || {};

  let contextInfo = '';

  if (topics && topics.length > 0) {
    contextInfo += \`\\nAvailable topics: \${topics.join(', ')}\`;
  }

  if (categories && categories.length > 0) {
    contextInfo += \`\\nAvailable categories: \${categories.join(', ')}\`;
  }

  if (difficulties && difficulties.length > 0) {
    contextInfo += \`\\nAvailable difficulty levels: \${difficulties.join(', ')}\`;
  }

  if (questionTypes && questionTypes.length > 0) {
    contextInfo += \`\\nAvailable question types: \${questionTypes.join(', ')}\`;
  }

  return \`I want to insert the above questions into supabase database. Convert the above questions to the below sql format. don't output anything else\${contextInfo}

---

\${SQL_TEMPLATE}\`;
};
`;

  // Write the TypeScript file
  fs.writeFileSync(TS_OUTPUT, tsContent, 'utf-8');

  console.log('✅ Successfully synced SQL template to TypeScript file');
  console.log(`   Source: ${path.relative(process.cwd(), SQL_SOURCE)}`);
  console.log(`   Output: ${path.relative(process.cwd(), TS_OUTPUT)}`);
} catch (error) {
  console.error('❌ Error syncing SQL template:', error.message);
  process.exit(1);
}
